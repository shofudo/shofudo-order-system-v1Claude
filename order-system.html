<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚ªãƒ¼ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            padding: 10px;
            min-height: 100vh;
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: #f5f0e8;
            padding: 10px 0;
            z-index: 100;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #e0d8cc;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* è¨­å®šãƒšãƒ¼ã‚¸ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0d8cc;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #faf8f5;
            border-radius: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 16px;
            cursor: pointer;
            flex: 1;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0d8cc;
            border-radius: 8px;
            font-size: 16px;
        }

        .room-config {
            border: 2px solid #e0d8cc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfcfa;
        }

        .room-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-config-header h4 {
            color: #8b7355;
            font-size: 18px;
        }

        .delete-room-btn {
            background: #d88a8a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 6px rgba(139, 115, 85, 0.3);
        }

        .btn-secondary {
            background: #e0d8cc;
            color: #666;
        }

        /* å–¶æ¥­ãƒšãƒ¼ã‚¸ */
        .time-group {
            margin-bottom: 25px;
        }

        .time-header {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.3);
        }

        .room-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0ebe3;
        }

        .room-name {
            font-size: 20px;
            font-weight: bold;
            color: #8b7355;
        }

        .room-plan {
            font-size: 14px;
            color: #999;
            margin-top: 3px;
        }

        .room-people {
            font-size: 32px;
            font-weight: bold;
            color: #8b7355;
        }

        .room-memo {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .course-item {
            text-align: center;
        }

        .course-name {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .course-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #ddd;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 auto 5px;
            position: relative;
        }

        .course-button.status-wait {
            background: #fff9e6;
            border-color: #f5d742;
            color: #333;
        }

        .course-button.status-order {
            background: #ffe8d6;
            border-color: #ff9f5a;
            color: #333;
        }

        .course-button.status-meat {
            background: #ffe0e6;
            border-color: #ff6b9d;
            color: #333;
        }

        .course-button.status-serve {
            background: #d4f4dd;
            border-color: #52c97a;
            color: #333;
        }

        .course-info {
            font-size: 11px;
            color: #666;
            min-height: 30px;
        }

        .time-display {
            font-weight: bold;
            color: #8b7355;
            font-size: 13px;
        }

        .staff-display {
            color: #666;
            font-size: 11px;
            margin-top: 2px;
        }

        .allergy-badge {
            font-size: 10px;
            color: #d88a8a;
            font-weight: bold;
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #d88a8a;
            white-space: nowrap;
        }

        .cake-badge {
            display: inline-block;
            background: #ffd6e0;
            color: #d5006d;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .pressed-time {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-btn {
            padding: 18px;
            border: 2px solid #e0d8cc;
            border-radius: 12px;
            background: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:active {
            background: #f0ebe3;
        }

        .modal-close {
            width: 100%;
            padding: 15px;
            background: #e0d8cc;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .w-count-display {
            font-size: 11px;
            font-weight: bold;
            color: #ff1744;
            margin-top: 3px;
        }

        .staff-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .undo-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .undo-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .course-button {
                width: 60px;
                height: 60px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('index')">è¨­å®š (Index)</button>
            <button class="tab-btn" onclick="switchTab('order')">å–¶æ¥­ (Order)</button>
        </div>

        <!-- è¨­å®šãƒšãƒ¼ã‚¸ -->
        <div id="index-page" class="page active">
            <div class="section">
                <div class="section-title">1. éƒ¨å±‹è¨­å®š</div>
                <div class="room-grid" id="room-checkboxes">
                    <!-- å›ºå®šéƒ¨å±‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                </div>
            </div>

            <div class="section">
                <div class="section-title">2. å„éƒ¨å±‹ã®è¨­å®š</div>
                <div id="room-configs">
                    <!-- å„éƒ¨å±‹ã®è¨­å®šãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>

            <div class="section">
                <div class="section-title">7. è¿½åŠ æ–™ç†</div>
                <div id="additional-dishes">
                    <!-- è¿½åŠ æ–™ç†ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
                <button class="btn btn-secondary" onclick="addAdditionalDish()">è¿½åŠ æ–™ç†ã‚’è¿½åŠ </button>
            </div>

            <div class="section">
                <div class="section-title">9. ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆå‡ºå‹¤è€…ï¼‰é¸æŠ</div>
                <div class="room-grid" id="staff-checkboxes">
                    <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜ã—ã¦å–¶æ¥­ãƒšãƒ¼ã‚¸ã¸</button>
            <button class="btn btn-secondary" onclick="resetSettings()">åˆæœŸåŒ–</button>
        </div>

        <!-- å–¶æ¥­ãƒšãƒ¼ã‚¸ -->
        <div id="order-page" class="page">
            <div id="order-content">
                <!-- å–¶æ¥­å†…å®¹ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
            <button class="undo-btn" onclick="undoLastAction()">â†¶</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title"></div>
            <div id="modal-body"></div>
            <button class="modal-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        const FIXED_ROOMS = ['ã‚„ã¾ã¶ã', 'ãªã§ã—ã“', 'ã¤ã°ã', 'ã‚„ã—ãŠ', 'ã•ãã‚‰', 'ãµã˜', 'ã•ã¤ã', 'ãã™ã’', 'ã‚†ã‚Š', 'ã¯ã'];
        const FIXED_STAFF = ['çœŸå¼“', 'ãƒŸãƒ³ã‚°ãƒ', 'ãƒœãƒ“ãƒ¼', 'ã‚µãƒ©ãƒŸ', 'ãƒ‘ãƒ“', 'ç¿”å¹³'];
        
        const PLANS = {
            'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰': ['å¸ç‰©', 'æœèœç››ã‚Š', 'è’¸ç‰©', 'æšç‰©', 'ç…®ç‰©', 'ã”é£¯', 'ç”˜å‘³'],
            'å’Œç‰›æ‡çŸ³': ['å¸ç‰©', 'æœèœç››ã‚Š', 'ã™ãç„¼ã', 'ãƒ•ãƒ©ã‚¤', 'ã‚¹ãƒ†ãƒ¼ã‚­', 'ã”é£¯', 'ç”˜å‘³'],
            'ã‚¹ãƒ†ãƒ¼ã‚­': ['å¸ç‰©', 'æœèœç››ã‚Š', 'è’¸ç‰©', 'æšç‰©', 'ã‚¹ãƒ†ãƒ¼ã‚­', 'ã”é£¯', 'ç”˜å‘³'],
            'ã—ã‚ƒã¶ã—ã‚ƒã¶': ['å¸ç‰©', 'æœèœç››ã‚Š', 'ã—ã‚ƒã¶ã—ã‚ƒã¶', 'è’¸ç‰©', 'æšç‰©', 'ã”é£¯', 'ç”˜å‘³'],
            'é€£æ³Š': ['èŒ¶ç¢—è’¸ã—', 'ç‰›ãŸãŸã', 'ç„¼ç‰©', 'å°é‰¢', 'æšç‰©', 'ã”é£¯', 'ç”˜å‘³']
        };

        let settings = {
            rooms: [],
            staff: [],
            additionalDishes: []
        };

        let orderState = {};
        let lastAction = null;

        // åˆæœŸåŒ–
        function init() {
            loadSettings();
            renderIndexPage();
            renderOrderPage();
        }

        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('orderSettings');
            if (saved) {
                settings = JSON.parse(saved);
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                settings = {
                    rooms: FIXED_ROOMS.map(name => ({
                        name: name,
                        enabled: true,
                        people: 2,
                        time: '18:00',
                        plan: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
                        memo: '',
                        allergies: {},
                        hasCake: false,
                        hasPlate: false
                    })),
                    staff: FIXED_STAFF.map(name => ({ name: name, enabled: true })),
                    additionalDishes: []
                };
            }

            const savedOrder = localStorage.getItem('orderState');
            if (savedOrder) {
                orderState = JSON.parse(savedOrder);
            }
        }

        // è¨­å®šä¿å­˜
        function saveSettings() {
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            initOrderState();
            saveOrderState();
            switchTab('order');
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // è¨­å®šåˆæœŸåŒ–
        function resetSettings() {
            if (!confirm('åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆéƒ¨å±‹ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ã¯å…¨é¸æŠã€äººæ•°2åã€æ™‚é–“18:00ã€ãƒ—ãƒ©ãƒ³ã¯ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ï¼‰')) {
                return;
            }
            
            settings = {
                rooms: FIXED_ROOMS.map(name => ({
                    name: name,
                    enabled: true,
                    people: 2,
                    time: '18:00',
                    plan: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
                    memo: '',
                    allergies: {},
                    hasCake: false,
                    hasPlate: false
                })),
                staff: FIXED_STAFF.map(name => ({ name: name, enabled: true })),
                additionalDishes: []
            };
            
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            renderIndexPage();
            alert('åˆæœŸåŒ–ã—ã¾ã—ãŸï¼');
        }

        // OrderçŠ¶æ…‹åˆæœŸåŒ–
        function initOrderState() {
            orderState = {};
            settings.rooms.filter(r => r.enabled).forEach(room => {
                const courses = PLANS[room.plan];
                orderState[room.name] = {
                    courses: {}
                };
                courses.forEach(course => {
                    orderState[room.name].courses[course] = {
                        status: 'none',
                        time: null,
                        pressedTime: null,
                        staff: null,
                        wCount: 0
                    };
                });
            });
        }

        // OrderçŠ¶æ…‹ä¿å­˜
        function saveOrderState() {
            localStorage.setItem('orderState', JSON.stringify(orderState));
        }

        // è¨­å®šãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderIndexPage() {
            // éƒ¨å±‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            const roomCheckboxes = document.getElementById('room-checkboxes');
            roomCheckboxes.innerHTML = '';
            settings.rooms.forEach((room, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="room-${index}" ${room.enabled ? 'checked' : ''} 
                           onchange="toggleRoom(${index})">
                    <label for="room-${index}">${room.name}</label>
                `;
                roomCheckboxes.appendChild(div);
            });

            // å„éƒ¨å±‹ã®è¨­å®š
            const roomConfigs = document.getElementById('room-configs');
            roomConfigs.innerHTML = '';
            settings.rooms.filter(r => r.enabled).forEach((room, index) => {
                const actualIndex = settings.rooms.indexOf(room);
                const div = document.createElement('div');
                div.className = 'room-config';
                
                const courses = PLANS[room.plan];
                const insertOptions = courses.map(c => `<option value="${c}">${c}ã®å‰</option>`).join('');
                
                div.innerHTML = `
                    <div class="room-config-header">
                        <h4>${room.name}</h4>
                    </div>
                    <div class="input-group">
                        <label>äººæ•°</label>
                        <input type="number" min="1" max="10" value="${room.people}" 
                               onchange="updateRoomPeople(${actualIndex}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>é–‹å§‹æ™‚é–“</label>
                        <select onchange="updateRoomTime(${actualIndex}, this.value)">
                            <option value="18:00" ${room.time === '18:00' ? 'selected' : ''}>18:00</option>
                            <option value="18:30" ${room.time === '18:30' ? 'selected' : ''}>18:30</option>
                            <option value="19:00" ${room.time === '19:00' ? 'selected' : ''}>19:00</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ãƒ—ãƒ©ãƒ³</label>
                        <select onchange="updateRoomPlan(${actualIndex}, this.value)">
                            ${Object.keys(PLANS).map(p => 
                                `<option value="${p}" ${room.plan === p ? 'selected' : ''}>${p}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>éƒ¨å±‹ãƒ¡ãƒ¢ï¼ˆ10æ–‡å­—ã¾ã§ï¼‰</label>
                        <input type="text" maxlength="10" value="${room.memo}" 
                               onchange="updateRoomMemo(${actualIndex}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" ${room.hasCake ? 'checked' : ''} 
                                   onchange="updateRoomCake(${actualIndex}, this.checked)"> ã‚±ãƒ¼ã‚­
                        </label>
                        <label style="margin-left: 15px;">
                            <input type="checkbox" ${room.hasPlate ? 'checked' : ''} 
                                   onchange="updateRoomPlate(${actualIndex}, this.checked)"> ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </label>
                    </div>
                    <div class="input-group">
                        <label>æ–™ç†åˆ¥ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼è¨­å®š</label>
                        ${courses.map(course => `
                            <div style="margin: 8px 0;">
                                <label style="font-weight: normal; font-size: 14px;">${course}:</label>
                                <input type="text" placeholder="ä¾‹: ãˆã³ãƒ»ã‹ã«" 
                                       value="${room.allergies[course] || ''}"
                                       onchange="updateAllergy(${actualIndex}, '${course}', this.value)"
                                       style="margin-top: 5px;">
                            </div>
                        `).join('')}
                    </div>
                `;
                roomConfigs.appendChild(div);
            });

            // ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            const staffCheckboxes = document.getElementById('staff-checkboxes');
            staffCheckboxes.innerHTML = '';
            settings.staff.forEach((staff, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="staff-${index}" ${staff.enabled ? 'checked' : ''} 
                           onchange="toggleStaff(${index})">
                    <label for="staff-${index}">${staff.name}</label>
                `;
                staffCheckboxes.appendChild(div);
            });

            // è¿½åŠ æ–™ç†
            renderAdditionalDishes();
        }

        // è¿½åŠ æ–™ç†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAdditionalDishes() {
            const container = document.getElementById('additional-dishes');
            container.innerHTML = '';
            
            settings.additionalDishes.forEach((dish, index) => {
                const div = document.createElement('div');
                div.className = 'room-config';
                div.innerHTML = `
                    <div class="room-config-header">
                        <h4>è¿½åŠ æ–™ç† ${index + 1}</h4>
                        <button class="delete-room-btn" onclick="removeAdditionalDish(${index})">å‰Šé™¤</button>
                    </div>
                    <div class="input-group">
                        <label>å“å</label>
                        <input type="text" value="${dish.name}" 
                               onchange="updateDishName(${index}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>æ•°é‡</label>
                        <input type="number" min="1" max="10" value="${dish.quantity}" 
                               onchange="updateDishQuantity(${index}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>å¯¾è±¡éƒ¨å±‹</label>
                        ${settings.rooms.filter(r => r.enabled).map((room, rIndex) => {
                            const actualIndex = settings.rooms.indexOf(room);
                            const checked = dish.rooms.includes(actualIndex) ? 'checked' : '';
                            return `
                                <label style="display: inline-block; margin-right: 15px; font-weight: normal;">
                                    <input type="checkbox" ${checked} 
                                           onchange="toggleDishRoom(${index}, ${actualIndex}, this.checked)">
                                    ${room.name}
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <div class="input-group">
                        <label>æŒ¿å…¥ä½ç½®</label>
                        ${dish.rooms.map(roomIndex => {
                            const room = settings.rooms[roomIndex];
                            const courses = PLANS[room.plan];
                            const currentPos = dish.positions[roomIndex] || courses[0];
                            return `
                                <div style="margin: 8px 0;">
                                    <label style="font-weight: normal; font-size: 14px;">${room.name}:</label>
                                    <select onchange="updateDishPosition(${index}, ${roomIndex}, this.value)" 
                                            style="margin-top: 5px;">
                                        ${courses.map(c => 
                                            `<option value="${c}" ${currentPos === c ? 'selected' : ''}>${c}ã®å‰</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addAdditionalDish() {
            settings.additionalDishes.push({
                name: '',
                quantity: 1,
                rooms: [],
                positions: {}
            });
            renderAdditionalDishes();
        }

        function removeAdditionalDish(index) {
            settings.additionalDishes.splice(index, 1);
            renderAdditionalDishes();
        }

        function updateDishName(index, value) {
            settings.additionalDishes[index].name = value;
        }

        function updateDishQuantity(index, value) {
            settings.additionalDishes[index].quantity = parseInt(value);
        }

        function toggleDishRoom(dishIndex, roomIndex, checked) {
            const dish = settings.additionalDishes[dishIndex];
            if (checked) {
                if (!dish.rooms.includes(roomIndex)) {
                    dish.rooms.push(roomIndex);
                    const room = settings.rooms[roomIndex];
                    const courses = PLANS[room.plan];
                    dish.positions[roomIndex] = courses[0];
                }
            } else {
                dish.rooms = dish.rooms.filter(r => r !== roomIndex);
                delete dish.positions[roomIndex];
            }
            renderAdditionalDishes();
        }

        function updateDishPosition(dishIndex, roomIndex, position) {
            settings.additionalDishes[dishIndex].positions[roomIndex] = position;
        }

        // å–¶æ¥­ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderOrderPage() {
            const content = document.getElementById('order-content');
            content.innerHTML = '';

            // æ™‚é–“å¸¯ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const timeGroups = {
                '18:00': [],
                '18:30': [],
                '19:00': []
            };

            settings.rooms.filter(r => r.enabled).forEach(room => {
                timeGroups[room.time].push(room);
            });

            // å„æ™‚é–“å¸¯ã‚’è¡¨ç¤º
            Object.keys(timeGroups).forEach(time => {
                if (timeGroups[time].length === 0) return;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-group';
                timeDiv.innerHTML = `<div class="time-header">${time} é–‹å§‹</div>`;

                timeGroups[time].forEach(room => {
                    const roomDiv = createRoomCard(room);
                    timeDiv.appendChild(roomDiv);
                });

                content.appendChild(timeDiv);
            });

            // åˆæœŸåŒ–ãƒœã‚¿ãƒ³
            const resetBtn = document.createElement('button');
            resetBtn.className = 'btn btn-secondary';
            resetBtn.textContent = 'OrderåˆæœŸåŒ–';
            resetBtn.onclick = resetOrderState;
            resetBtn.style.marginTop = '20px';
            content.appendChild(resetBtn);
        }

        function createRoomCard(room) {
            const div = document.createElement('div');
            div.className = 'room-card';

            const courses = PLANS[room.plan];
            const roomState = orderState[room.name] || { courses: {} };

            let cakeInfo = '';
            if (room.hasCake) cakeInfo += '<span class="cake-badge">ğŸ‚ã‚±ãƒ¼ã‚­</span>';
            if (room.hasPlate) cakeInfo += '<span class="cake-badge">ğŸ½ï¸ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>';

            div.innerHTML = `
                <div class="room-header">
                    <div>
                        <div class="room-name">${room.name}</div>
                        <div class="room-plan">${room.plan}</div>
                        ${room.memo ? `<div class="room-memo">${room.memo}</div>` : ''}
                    </div>
                    <div class="room-people">${room.people}å</div>
                </div>
                <div class="course-grid" id="courses-${room.name}">
                    ${courses.map(course => createCourseButton(room, course, roomState.courses[course])).join('')}
                </div>
            `;

            return div;
        }

        function createCourseButton(room, course, state) {
            if (!state) {
                state = { status: 'none', time: null, pressedTime: null, staff: null, wCount: 0 };
            }

            const allergy = room.allergies[course] || '';
            const allergyBadge = allergy ? `<div class="allergy-badge">${allergy}NG</div>` : '';
            
            let buttonText = 'æœª';
            let statusClass = '';
            
            if (state.status === 'wait') {
                buttonText = state.time ? state.time.split(':')[1] : 'å¾…';
                statusClass = 'status-wait';
            } else if (state.status === 'order') {
                buttonText = 'æ³¨';
                statusClass = 'status-order';
            } else if (state.status === 'meat') {
                buttonText = 'è‚‰';
                statusClass = 'status-meat';
            } else if (state.status === 'serve') {
                buttonText = 'æ';
                statusClass = 'status-serve';
            }

            const cakeBadge = (course === 'ç”˜å‘³' && (room.hasCake || room.hasPlate)) ? 
                `${room.hasCake ? '<span class="cake-badge">ğŸ‚</span>' : ''}${room.hasPlate ? '<span class="cake-badge">ğŸ½ï¸</span>' : ''}` : '';

            return `
                <div class="course-item">
                    <div class="course-name">${course}${cakeBadge}</div>
                    <div class="course-button ${statusClass}" onclick="clickCourse('${room.name}', '${course}')">
                        ${allergyBadge}
                        ${buttonText}
                    </div>
                    <div class="course-info">
                        ${state.time ? `<div class="time-display">${state.time}</div>` : ''}
                        ${state.pressedTime ? `<div class="pressed-time">${state.pressedTime}</div>` : ''}
                        ${state.staff ? `<div class="staff-display">${state.staff}</div>` : ''}
                        ${state.wCount > 0 ? `<div class="w-count-display">WÃ—${state.wCount}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // ã‚³ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        function clickCourse(roomName, courseName) {
            const room = settings.rooms.find(r => r.name === roomName);
            if (!room) return;

            const state = orderState[roomName].courses[courseName];
            
            // æœ€å¾Œã®æ“ä½œã‚’ä¿å­˜
            lastAction = {
                room: roomName,
                course: courseName,
                previousState: JSON.parse(JSON.stringify(state))
            };

            // çŠ¶æ…‹é·ç§»
            if (courseName === 'æœèœç››ã‚Š' || courseName === 'ã—ã‚ƒã¶ã—ã‚ƒã¶') {
                // æœèœç››ã‚Šã€ã—ã‚ƒã¶ã—ã‚ƒã¶: æœª â†’ å¾… â†’ æ â†’ æœª
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                } else if (state.status === 'wait') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                }
            } else if (courseName === 'ã‚¹ãƒ†ãƒ¼ã‚­' || courseName === 'ç…®ç‰©') {
                // ã‚¹ãƒ†ãƒ¼ã‚­ã€ç…®ç‰©: æœª â†’ å¾… â†’ è‚‰ â†’ æ³¨ â†’ æ â†’ æœª
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                    showTimeModal(roomName, courseName);
                } else if (state.status === 'wait') {
                    state.status = 'meat';
                    showWCountModal(roomName, courseName);
                } else if (state.status === 'meat') {
                    state.status = 'order';
                } else if (state.status === 'order') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                    state.wCount = 0;
                }
            } else {
                // é€šå¸¸: æœª â†’ å¾… â†’ æ³¨ â†’ æ â†’ æœª
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                    showTimeModal(roomName, courseName);
                } else if (state.status === 'wait') {
                    state.status = 'order';
                } else if (state.status === 'order') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                }
            }

            saveOrderState();
            renderOrderPage();
        }

        // ç¾åœ¨æ™‚åˆ»å–å¾—
        function getCurrentTime() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        }

        // æ™‚é–“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
        function showTimeModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'æä¾›äºˆå®šæ™‚åˆ»ã‚’é¸æŠ';
            
            const options = [3, 5, 10, 15, 20, 25];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(min => `
                        <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', ${min})">
                            +${min}åˆ†
                        </button>
                    `).join('')}
                    <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', 0)">
                        å£°ãŒã‘
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function setTime(roomName, courseName, minutes) {
            const state = orderState[roomName].courses[courseName];
            
            if (minutes > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + minutes);
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                state.time = `${h}:${m}`;
            } else {
                state.time = 'å£°ãŒã‘';
            }

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // Wæ•°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
        function showWCountModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            const room = settings.rooms.find(r => r.name === roomName);
            title.textContent = 'ç„¼ãåŠ æ¸›ã‚’é¸æŠ';
            
            const options = ['ãªã—', ...Array.from({length: room.people}, (_, i) => i + 1)];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(opt => `
                        <button class="modal-btn" onclick="setWCount('${roomName}', '${courseName}', '${opt}')">
                            ${opt === 'ãªã—' ? 'ãªã—' : opt + 'å'}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setWCount(roomName, courseName, count) {
            const state = orderState[roomName].courses[courseName];
            state.wCount = count === 'ãªã—' ? 0 : parseInt(count);

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
        function showStaffModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = 'æä¾›ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ';
            
            const enabledStaff = settings.staff.filter(s => s.enabled);
            body.innerHTML = `
                <div class="staff-select-grid">
                    ${enabledStaff.map(staff => `
                        <button class="modal-btn" onclick="setStaff('${roomName}', '${courseName}', '${staff.name}')">
                            ${staff.name}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setStaff(roomName, courseName, staffName) {
            const state = orderState[roomName].courses[courseName];
            state.staff = staffName;

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Undo
        function undoLastAction() {
            if (!lastAction) {
                alert('å…ƒã«æˆ»ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            orderState[lastAction.room].courses[lastAction.course] = lastAction.previousState;
            lastAction = null;

            saveOrderState();
            renderOrderPage();
        }

        // OrderåˆæœŸåŒ–
        function resetOrderState() {
            if (!confirm('Orderãƒšãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            initOrderState();
            saveOrderState();
            renderOrderPage();
            alert('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            if (tab === 'index') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('index-page').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('order-page').classList.add('active');
                renderOrderPage();
            }
        }

        // è¨­å®šæ›´æ–°é–¢æ•°
        function toggleRoom(index) {
            settings.rooms[index].enabled = !settings.rooms[index].enabled;
            renderIndexPage();
        }

        function updateRoomPeople(index, value) {
            settings.rooms[index].people = parseInt(value);
        }

        function updateRoomTime(index, value) {
            settings.rooms[index].time = value;
        }

        function updateRoomPlan(index, value) {
            settings.rooms[index].plan = value;
            settings.rooms[index].allergies = {};
            renderIndexPage();
        }

        function updateRoomMemo(index, value) {
            settings.rooms[index].memo = value;
        }

        function updateRoomCake(index, checked) {
            settings.rooms[index].hasCake = checked;
        }

        function updateRoomPlate(index, checked) {
            settings.rooms[index].hasPlate = checked;
        }

        function updateAllergy(roomIndex, course, value) {
            settings.rooms[roomIndex].allergies[course] = value;
        }

        function toggleStaff(index) {
            settings.staff[index].enabled = !settings.staff[index].enabled;
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>