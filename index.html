<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>オーダーシステム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #ebe4d8 100%);
            color: #333;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100vw;
            padding: 5px;
            min-height: 100vh;
        }

        /* タブ切り替え */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            position: sticky;
            top: 0;
            background: #f5f0e8;
            padding: 5px 0;
            z-index: 100;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #e0d8cc;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(139, 115, 85, 0.3);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 設定ページ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0d8cc;
        }

        /* 表形式の設定テーブル */
        .settings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .settings-table th {
            background: #f5f0e8;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            color: #666;
            border: 1px solid #e0d8cc;
        }

        .settings-table td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #e0d8cc;
        }

        .settings-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-table input[type="text"],
        .settings-table input[type="number"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #e0d8cc;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .settings-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #e0d8cc;
            border-radius: 4px;
            font-size: 14px;
        }

        .allergy-btn {
            background: #e0d8cc;
            color: #666;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .allergy-btn:active {
            background: #d0c8bc;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            white-space: nowrap;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .custom-input-row {
            background: #faf8f5;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #faf8f5;
            border-radius: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 16px;
            cursor: pointer;
            flex: 1;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0d8cc;
            border-radius: 8px;
            font-size: 16px;
        }

        .room-config {
            border: 2px solid #e0d8cc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fdfcfa;
        }

        .room-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-config-header h4 {
            color: #8b7355;
            font-size: 18px;
        }

        .delete-room-btn {
            background: #d88a8a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .allergy-modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        .allergy-input-group {
            margin-bottom: 15px;
        }

        .allergy-input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .allergy-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0d8cc;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 115, 85, 0.3);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(139, 115, 85, 0.3);
        }

        .btn-secondary {
            background: #e0d8cc;
            color: #666;
        }

        /* 営業ページ */
        .time-group {
            margin-bottom: 6px;
        }

        .time-header {
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(139, 115, 85, 0.3);
        }

        .room-card {
            background: white;
            border-radius: 8px;
            padding: 6px;
            margin-bottom: 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .room-info {
            min-width: 100px;
            max-width: 100px;
            padding-right: 8px;
            border-right: 2px solid #f0ebe3;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1px;
        }

        .room-name {
            font-size: 14px;
            font-weight: bold;
            color: #8b7355;
        }

        .room-plan {
            font-size: 9px;
            color: #999;
            margin-top: 1px;
        }

        .room-people {
            font-size: 20px;
            font-weight: bold;
            color: #8b7355;
        }

        .room-memo {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }

        .eating-speed {
            display: inline-block;
            padding: 2px 6px;
            background: #e8e8e8;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 3px;
            transition: all 0.3s;
        }

        .eating-speed:active {
            background: #d8d8d8;
        }

        .course-grid {
            display: flex;
            gap: 6px;
            flex: 1;
            flex-wrap: wrap;
            align-items: center;
        }

        .course-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .course-name {
            font-size: 9px;
            color: #666;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .course-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2px;
            position: relative;
        }

        .course-button.status-wait {
            background: #fff9e6;
            border-color: #f5d742;
            color: #333;
        }

        .course-button.status-order {
            background: #ffe8d6;
            border-color: #ff9f5a;
            color: #333;
        }

        .course-button.status-meat {
            background: #ffe0e6;
            border-color: #ff6b9d;
            color: #333;
        }

        .course-button.status-serve {
            background: #d4f4dd;
            border-color: #52c97a;
            color: #333;
        }

        .course-info {
            font-size: 8px;
            color: #666;
            min-height: 16px;
        }

        .time-display {
            font-weight: bold;
            color: #8b7355;
            font-size: 9px;
        }

        .staff-display {
            color: #666;
            font-size: 8px;
            margin-top: 1px;
        }

        .allergy-badge {
            font-size: 7px;
            color: #d88a8a;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
            background: white;
            padding: 1px 3px;
            border-radius: 6px;
            border: 1px solid #d88a8a;
            white-space: nowrap;
        }

        .cake-badge {
            display: inline-block;
            background: #ffd6e0;
            color: #d5006d;
            padding: 1px 4px;
            border-radius: 6px;
            font-size: 8px;
            font-weight: bold;
            margin-left: 2px;
        }

        .pressed-time {
            font-size: 7px;
            color: #999;
            margin-top: 1px;
        }

        .w-count-display {
            font-size: 8px;
            font-weight: bold;
            color: #ff1744;
            margin-top: 1px;
        }

        .additional-dish-name {
            color: #8b7355;
            font-weight: bold;
        }

        .quantity-badge {
            font-size: 7px;
            background: #e8e8e8;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 2px;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #8b7355;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-btn {
            padding: 18px;
            border: 2px solid #e0d8cc;
            border-radius: 12px;
            background: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:active {
            background: #f0ebe3;
        }

        .modal-close {
            width: 100%;
            padding: 15px;
            background: #e0d8cc;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .w-count-display {
            font-size: 11px;
            font-weight: bold;
            color: #ff1744;
            margin-top: 3px;
        }

        .staff-select-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .undo-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b7355 0%, #a08968 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .undo-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .course-button {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
            
            .room-info {
                min-width: 90px;
                max-width: 90px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- タブボタン -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('index')">設定 (Index)</button>
            <button class="tab-btn" onclick="switchTab('order')">営業 (Order)</button>
        </div>

        <!-- 設定ページ -->
        <div id="index-page" class="page active">
            <div class="section">
                <div class="section-title">1. 本日の設定</div>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    チェックした部屋だけが営業ページに反映される設定です。
                </p>
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">選</th>
                            <th style="width: 100px;">部屋名</th>
                            <th style="width: 80px;">人数</th>
                            <th style="width: 120px;">プラン</th>
                            <th style="width: 100px;">夕食開始</th>
                            <th style="width: 180px;">お祝い・アレルギー</th>
                            <th style="width: 100px;">部屋メモ</th>
                        </tr>
                    </thead>
                    <tbody id="room-settings-table">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">7. 追加料理</div>
                <div id="additional-dishes">
                    <!-- 追加料理が動的に追加される -->
                </div>
                <button class="btn btn-secondary" onclick="addAdditionalDish()">追加料理を追加</button>
            </div>

            <div class="section">
                <div class="section-title">9. スタッフ（出勤者）選択</div>
                <div class="room-grid" id="staff-checkboxes">
                    <!-- スタッフチェックボックス -->
                </div>
                <div style="margin-top: 15px;">
                    <label style="font-weight: bold; margin-bottom: 8px; display: block;">カスタマイズスタッフ</label>
                    <input type="text" id="custom-staff-input" placeholder="スタッフ名を入力" 
                           style="width: 100%; padding: 12px; border: 2px solid #e0d8cc; border-radius: 8px; font-size: 16px;">
                    <button class="btn btn-secondary" onclick="addCustomStaff()" style="margin-top: 10px;">
                        カスタマイズスタッフを追加
                    </button>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">保存して営業ページへ</button>
            <button class="btn btn-secondary" onclick="resetSettings()">初期化</button>
        </div>

        <!-- 営業ページ -->
        <div id="order-page" class="page">
            <div id="order-content">
                <!-- 営業内容が動的に生成される -->
            </div>
            <button class="undo-btn" onclick="undoLastAction()">↶</button>
        </div>
    </div>

    <!-- モーダル -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title"></div>
            <div id="modal-body"></div>
            <button class="modal-close" onclick="closeModal()">閉じる</button>
        </div>
    </div>

    <script>
        // データ構造
        const FIXED_ROOMS = ['やまぶき', 'なでしこ', 'つばき', 'やしお', 'さくら', 'ふじ', 'さつき', 'きすげ', 'ゆり', 'はぎ'];
        const FIXED_STAFF = ['真弓', 'ミングマ', 'ボビー', 'サラミ', 'パビ', '翔平'];
        
        const PLANS = {
            'スタンダード': ['吸物', '果菜盛り', '蒸物', '揚物', '煮物', 'ご飯', '甘味'],
            '和牛懐石': ['吸物', '果菜盛り', 'すき焼き', 'フライ', 'ステーキ', 'ご飯', '甘味'],
            'ステーキ': ['吸物', '果菜盛り', '蒸物', '揚物', 'ステーキ', 'ご飯', '甘味'],
            'しゃぶしゃぶ': ['吸物', '果菜盛り', 'しゃぶしゃぶ', '蒸物', '揚物', 'ご飯', '甘味'],
            '連泊': ['茶碗蒸し', '牛たたき', '焼物', '小鉢', '揚物', 'ご飯', '甘味']
        };

        let settings = {
            rooms: [],
            staff: [],
            additionalDishes: [],
            customRooms: [],
            customStaff: []
        };

        let orderState = {};
        let lastAction = null;

        const EATING_SPEEDS = ['VF', 'F', 'LF', 'N', 'LS', 'S', 'VS'];

        // 初期化
        function init() {
            loadSettings();
            renderIndexPage();
            renderOrderPage();
        }

        // 設定読み込み
        function loadSettings() {
            const saved = localStorage.getItem('orderSettings');
            if (saved) {
                settings = JSON.parse(saved);
                // 古いデータの互換性のため
                if (!settings.customRooms) settings.customRooms = [];
                if (!settings.customStaff) settings.customStaff = [];
            } else {
                // デフォルト設定
                settings = {
                    rooms: FIXED_ROOMS.map(name => ({
                        name: name,
                        enabled: true,
                        people: 2,
                        time: '18:00',
                        plan: 'スタンダード',
                        memo: '',
                        allergies: {},
                        hasCake: false,
                        hasPlate: false,
                        isCustom: false
                    })),
                    staff: FIXED_STAFF.map(name => ({ name: name, enabled: true, isCustom: false })),
                    additionalDishes: [],
                    customRooms: [],
                    customStaff: []
                };
            }

            const savedOrder = localStorage.getItem('orderState');
            if (savedOrder) {
                orderState = JSON.parse(savedOrder);
            }
        }

        // 設定保存
        function saveSettings() {
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            initOrderState();
            saveOrderState();
            switchTab('order');
            alert('設定を保存しました！');
        }

        // 設定初期化
        function resetSettings() {
            if (!confirm('初期状態に戻しますか？\n（部屋・スタッフは全選択、人数2名、時間18:00、プランはスタンダードになります）')) {
                return;
            }
            
            settings = {
                rooms: FIXED_ROOMS.map(name => ({
                    name: name,
                    enabled: true,
                    people: 2,
                    time: '18:00',
                    plan: 'スタンダード',
                    memo: '',
                    allergies: {},
                    hasCake: false,
                    hasPlate: false,
                    isCustom: false
                })),
                staff: FIXED_STAFF.map(name => ({ name: name, enabled: true, isCustom: false })),
                additionalDishes: [],
                customRooms: [],
                customStaff: []
            };
            
            localStorage.setItem('orderSettings', JSON.stringify(settings));
            renderIndexPage();
            alert('初期化しました！');
        }

        // Order状態初期化
        function initOrderState() {
            orderState = {};
            const allRooms = [...settings.rooms.filter(r => r.enabled), ...settings.customRooms.filter(r => r.enabled)];
            
            allRooms.forEach(room => {
                const courses = PLANS[room.plan];
                orderState[room.name] = {
                    eatingSpeed: 'N',
                    courses: {}
                };
                
                // 通常の料理
                courses.forEach(course => {
                    orderState[room.name].courses[course] = {
                        status: 'none',
                        time: null,
                        pressedTime: null,
                        staff: null,
                        wCount: 0
                    };
                });
                
                // 追加料理
                const roomIndex = room.isCustom ? 
                    'custom-' + settings.customRooms.indexOf(room) : 
                    settings.rooms.indexOf(room);
                
                settings.additionalDishes.forEach(dish => {
                    if (dish.rooms.includes(roomIndex)) {
                        orderState[room.name].courses[dish.name] = {
                            status: 'none',
                            time: null,
                            pressedTime: null,
                            staff: null,
                            wCount: 0
                        };
                    }
                });
            });
        }

        // Order状態保存
        function saveOrderState() {
            localStorage.setItem('orderState', JSON.stringify(orderState));
        }

        // 設定ページレンダリング
        function renderIndexPage() {
            // 部屋設定テーブル
            const tableBody = document.getElementById('room-settings-table');
            tableBody.innerHTML = '';
            
            // 全ての部屋（固定＋カスタム）
            const allRooms = [...settings.rooms, ...settings.customRooms];
            
            allRooms.forEach((room, index) => {
                const tr = document.createElement('tr');
                if (room.isCustom) tr.className = 'custom-input-row';
                
                const isCustomRoom = room.isCustom;
                const actualIndex = isCustomRoom ? 
                    settings.rooms.length + settings.customRooms.indexOf(room) : 
                    settings.rooms.indexOf(room);
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" ${room.enabled ? 'checked' : ''} 
                               onchange="${isCustomRoom ? `toggleCustomRoom(${settings.customRooms.indexOf(room)})` : `toggleRoom(${actualIndex})`}">
                    </td>
                    <td>
                        ${isCustomRoom ? 
                            `<input type="text" value="${room.name}" onchange="updateCustomRoomName(${settings.customRooms.indexOf(room)}, this.value)" placeholder="部屋名">` : 
                            room.name
                        }
                        ${isCustomRoom ? 
                            `<br><button class="delete-room-btn" style="margin-top: 5px; padding: 4px 8px; font-size: 11px;" onclick="deleteCustomRoom(${settings.customRooms.indexOf(room)})">削除</button>` : 
                            ''
                        }
                    </td>
                    <td>
                        <input type="number" min="1" max="10" value="${room.people}" 
                               onchange="${isCustomRoom ? `updateCustomRoomPeople(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomPeople(${actualIndex}, this.value)`}">
                    </td>
                    <td>
                        <select onchange="${isCustomRoom ? `updateCustomRoomPlan(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomPlan(${actualIndex}, this.value)`}">
                            ${Object.keys(PLANS).map(p => 
                                `<option value="${p}" ${room.plan === p ? 'selected' : ''}>${p}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <select onchange="${isCustomRoom ? `updateCustomRoomTime(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomTime(${actualIndex}, this.value)`}">
                            <option value="18:00" ${room.time === '18:00' ? 'selected' : ''}>18:00</option>
                            <option value="18:30" ${room.time === '18:30' ? 'selected' : ''}>18:30</option>
                            <option value="19:00" ${room.time === '19:00' ? 'selected' : ''}>19:00</option>
                        </select>
                    </td>
                    <td>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" ${room.hasCake ? 'checked' : ''} 
                                       onchange="${isCustomRoom ? `updateCustomRoomCake(${settings.customRooms.indexOf(room)}, this.checked)` : `updateRoomCake(${actualIndex}, this.checked)`}">
                                ケーキ
                            </label>
                            <label>
                                <input type="checkbox" ${room.hasPlate ? 'checked' : ''} 
                                       onchange="${isCustomRoom ? `updateCustomRoomPlate(${settings.customRooms.indexOf(room)}, this.checked)` : `updateRoomPlate(${actualIndex}, this.checked)`}">
                                プレート
                            </label>
                        </div>
                        <button class="allergy-btn" style="margin-top: 5px;" 
                                onclick="${isCustomRoom ? `showAllergyModal(${settings.customRooms.indexOf(room)}, true)` : `showAllergyModal(${actualIndex}, false)`}">
                            アレルギー詳細設定
                        </button>
                    </td>
                    <td>
                        <input type="text" maxlength="10" value="${room.memo || ''}" placeholder="メモ"
                               onchange="${isCustomRoom ? `updateCustomRoomMemo(${settings.customRooms.indexOf(room)}, this.value)` : `updateRoomMemo(${actualIndex}, this.value)`}">
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            // カスタマイズ部屋追加行
            const addRow = document.createElement('tr');
            addRow.className = 'custom-input-row';
            addRow.innerHTML = `
                <td colspan="7" style="text-align: center; padding: 15px;">
                    <button class="btn btn-secondary" onclick="addCustomRoom()" style="width: auto; padding: 10px 30px;">
                        ＋ カスタマイズ部屋を追加
                    </button>
                </td>
            `;
            tableBody.appendChild(addRow);

            // スタッフチェックボックス
            const staffCheckboxes = document.getElementById('staff-checkboxes');
            staffCheckboxes.innerHTML = '';
            
            // 固定スタッフ
            settings.staff.forEach((staff, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="staff-${index}" ${staff.enabled ? 'checked' : ''} 
                           onchange="toggleStaff(${index})">
                    <label for="staff-${index}">${staff.name}</label>
                `;
                staffCheckboxes.appendChild(div);
            });
            
            // カスタムスタッフ
            settings.customStaff.forEach((staff, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.style.background = '#faf8f5';
                div.innerHTML = `
                    <input type="checkbox" id="custom-staff-${index}" ${staff.enabled ? 'checked' : ''} 
                           onchange="toggleCustomStaff(${index})">
                    <label for="custom-staff-${index}">${staff.name}</label>
                    <button class="delete-room-btn" style="margin-left: auto; padding: 6px 12px; font-size: 12px;" 
                            onclick="deleteCustomStaff(${index})">削除</button>
                `;
                staffCheckboxes.appendChild(div);
            });

            // 追加料理
            renderAdditionalDishes();
        }

        // 追加料理レンダリング
        function renderAdditionalDishes() {
            const container = document.getElementById('additional-dishes');
            container.innerHTML = '';
            
            const allRooms = [
                ...settings.rooms.filter(r => r.enabled),
                ...settings.customRooms.filter(r => r.enabled)
            ];
            
            settings.additionalDishes.forEach((dish, index) => {
                const div = document.createElement('div');
                div.className = 'room-config';
                div.innerHTML = `
                    <div class="room-config-header">
                        <h4>追加料理 ${index + 1}</h4>
                        <button class="delete-room-btn" onclick="removeAdditionalDish(${index})">削除</button>
                    </div>
                    <div class="input-group">
                        <label>品名</label>
                        <input type="text" value="${dish.name}" 
                               onchange="updateDishName(${index}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>数量</label>
                        <input type="number" min="1" max="10" value="${dish.quantity}" 
                               onchange="updateDishQuantity(${index}, this.value)">
                    </div>
                    <div class="input-group">
                        <label>対象部屋</label>
                        ${allRooms.map((room, rIndex) => {
                            // 実際のインデックスを取得（固定部屋かカスタム部屋か）
                            const actualIndex = room.isCustom ? 
                                'custom-' + settings.customRooms.indexOf(room) : 
                                settings.rooms.indexOf(room);
                            const checked = dish.rooms.includes(actualIndex) ? 'checked' : '';
                            return `
                                <label style="display: inline-block; margin-right: 15px; font-weight: normal;">
                                    <input type="checkbox" ${checked} 
                                           onchange="toggleDishRoom(${index}, '${actualIndex}', this.checked)">
                                    ${room.name}
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <div class="input-group">
                        <label>挿入位置</label>
                        ${dish.rooms.map(roomId => {
                            const room = roomId.toString().startsWith('custom-') ? 
                                settings.customRooms[parseInt(roomId.split('-')[1])] :
                                settings.rooms[roomId];
                            if (!room) return '';
                            const courses = PLANS[room.plan];
                            const currentPos = dish.positions[roomId] || courses[0];
                            return `
                                <div style="margin: 8px 0;">
                                    <label style="font-weight: normal; font-size: 14px;">${room.name}:</label>
                                    <select onchange="updateDishPosition(${index}, '${roomId}', this.value)" 
                                            style="margin-top: 5px;">
                                        ${courses.map(c => 
                                            `<option value="${c}" ${currentPos === c ? 'selected' : ''}>${c}の前</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addAdditionalDish() {
            settings.additionalDishes.push({
                name: '',
                quantity: 1,
                rooms: [],
                positions: {}
            });
            renderAdditionalDishes();
        }

        function removeAdditionalDish(index) {
            settings.additionalDishes.splice(index, 1);
            renderAdditionalDishes();
        }

        function updateDishName(index, value) {
            settings.additionalDishes[index].name = value;
        }

        function updateDishQuantity(index, value) {
            settings.additionalDishes[index].quantity = parseInt(value);
        }

        function toggleDishRoom(dishIndex, roomId, checked) {
            const dish = settings.additionalDishes[dishIndex];
            if (checked) {
                if (!dish.rooms.includes(roomId)) {
                    dish.rooms.push(roomId);
                    const room = roomId.toString().startsWith('custom-') ? 
                        settings.customRooms[parseInt(roomId.split('-')[1])] :
                        settings.rooms[roomId];
                    const courses = PLANS[room.plan];
                    dish.positions[roomId] = courses[0];
                }
            } else {
                dish.rooms = dish.rooms.filter(r => r !== roomId);
                delete dish.positions[roomId];
            }
            renderAdditionalDishes();
        }

        function updateDishPosition(dishIndex, roomId, position) {
            settings.additionalDishes[dishIndex].positions[roomId] = position;
        }

        // 営業ページレンダリング
        function renderOrderPage() {
            const content = document.getElementById('order-content');
            content.innerHTML = '';

            // 全ての有効な部屋（固定＋カスタム）
            const allRooms = [
                ...settings.rooms.filter(r => r.enabled),
                ...settings.customRooms.filter(r => r.enabled)
            ];

            // 時間帯でグループ化
            const timeGroups = {
                '18:00': [],
                '18:30': [],
                '19:00': []
            };

            allRooms.forEach(room => {
                if (timeGroups[room.time]) {
                    timeGroups[room.time].push(room);
                }
            });

            // 各時間帯を表示
            Object.keys(timeGroups).forEach(time => {
                if (timeGroups[time].length === 0) return;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-group';
                timeDiv.innerHTML = `<div class="time-header">${time} 開始</div>`;

                timeGroups[time].forEach(room => {
                    const roomDiv = createRoomCard(room);
                    timeDiv.appendChild(roomDiv);
                });

                content.appendChild(timeDiv);
            });

            // 初期化ボタン
            const resetBtn = document.createElement('button');
            resetBtn.className = 'btn btn-secondary';
            resetBtn.textContent = 'Order初期化';
            resetBtn.onclick = resetOrderState;
            resetBtn.style.marginTop = '20px';
            content.appendChild(resetBtn);
        }

        function createRoomCard(room) {
            const div = document.createElement('div');
            div.className = 'room-card';

            const baseCourses = PLANS[room.plan];
            const roomState = orderState[room.name] || { eatingSpeed: 'N', courses: {} };

            // 追加料理を含めたコース一覧を作成
            let coursesWithAdditional = [];
            
            // 部屋のインデックスを取得
            const roomIndex = room.isCustom ? 
                'custom-' + settings.customRooms.indexOf(room) : 
                settings.rooms.indexOf(room);
            
            // 各コースの前に追加料理があるかチェック
            baseCourses.forEach((course, index) => {
                // この料理の前に追加する料理を探す
                const additionalForThisCourse = settings.additionalDishes.filter(dish => {
                    return dish.rooms.includes(roomIndex) && dish.positions[roomIndex] === course;
                });
                
                // 追加料理があれば先に追加
                additionalForThisCourse.forEach(dish => {
                    coursesWithAdditional.push({
                        name: dish.name,
                        isAdditional: true,
                        quantity: dish.quantity
                    });
                });
                
                // 通常の料理を追加
                coursesWithAdditional.push({
                    name: course,
                    isAdditional: false
                });
            });

            let cakeInfo = '';
            if (room.hasCake) cakeInfo += '<span class="cake-badge">ケーキ</span>';
            if (room.hasPlate) cakeInfo += '<span class="cake-badge">プレート</span>';

            div.innerHTML = `
                <div class="room-info">
                    <div class="room-header">
                        <div class="room-name">${room.name}</div>
                        <div class="room-people">${room.people}名</div>
                    </div>
                    <div class="room-plan">${room.plan}${cakeInfo}</div>
                    ${room.memo ? `<div class="room-memo">${room.memo}</div>` : ''}
                    <div class="eating-speed" onclick="showEatingSpeedModal('${room.name}')">
                        ${roomState.eatingSpeed}
                    </div>
                </div>
                <div class="course-grid" id="courses-${room.name}">
                    ${coursesWithAdditional.map(courseObj => {
                        if (courseObj.isAdditional) {
                            return createAdditionalCourseButton(room, courseObj.name, courseObj.quantity, roomState.courses[courseObj.name]);
                        } else {
                            return createCourseButton(room, courseObj.name, roomState.courses[courseObj.name]);
                        }
                    }).join('')}
                </div>
            `;

            return div;
        }

        function createCourseButton(room, course, state) {
            if (!state) {
                state = { status: 'none', time: null, pressedTime: null, staff: null, wCount: 0 };
            }

            const allergy = room.allergies[course] || '';
            const allergyBadge = allergy ? `<div class="allergy-badge">${allergy}NG</div>` : '';
            
            let buttonText = '未';
            let statusClass = '';
            
            if (state.status === 'wait') {
                buttonText = state.time ? state.time.split(':')[1] : '待';
                statusClass = 'status-wait';
            } else if (state.status === 'order') {
                buttonText = '注';
                statusClass = 'status-order';
            } else if (state.status === 'meat') {
                buttonText = '肉';
                statusClass = 'status-meat';
            } else if (state.status === 'serve') {
                buttonText = '提';
                statusClass = 'status-serve';
            }

            const cakeBadge = (course === '甘味' && (room.hasCake || room.hasPlate)) ? 
                `${room.hasCake ? '<span class="cake-badge">ケーキ</span>' : ''}${room.hasPlate ? '<span class="cake-badge">プレート</span>' : ''}` : '';

            return `
                <div class="course-item">
                    <div class="course-name">${course}${cakeBadge}</div>
                    <div class="course-button ${statusClass}" onclick="clickCourse('${room.name}', '${course}')">
                        ${allergyBadge}
                        ${buttonText}
                    </div>
                    <div class="course-info">
                        ${state.time ? `<div class="time-display">${state.time}</div>` : ''}
                        ${state.pressedTime ? `<div class="pressed-time">${state.pressedTime}</div>` : ''}
                        ${state.staff ? `<div class="staff-display">${state.staff}</div>` : ''}
                        ${state.wCount > 0 ? `<div class="w-count-display">W×${state.wCount}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // 追加料理ボタン作成（通常の料理と同じ動作）
        function createAdditionalCourseButton(room, dishName, quantity, state) {
            if (!state) {
                state = { status: 'none', time: null, pressedTime: null, staff: null, wCount: 0 };
            }
            
            let buttonText = '未';
            let statusClass = '';
            
            if (state.status === 'wait') {
                buttonText = state.time ? state.time.split(':')[1] : '待';
                statusClass = 'status-wait';
            } else if (state.status === 'order') {
                buttonText = '注';
                statusClass = 'status-order';
            } else if (state.status === 'serve') {
                buttonText = '提';
                statusClass = 'status-serve';
            }
            
            return `
                <div class="course-item">
                    <div class="course-name additional-dish-name">
                        ${dishName}
                        <span class="quantity-badge">×${quantity}</span>
                    </div>
                    <div class="course-button ${statusClass}" onclick="clickCourse('${room.name}', '${dishName}')">
                        ${buttonText}
                    </div>
                    <div class="course-info">
                        ${state.time ? `<div class="time-display">${state.time}</div>` : ''}
                        ${state.pressedTime ? `<div class="pressed-time">${state.pressedTime}</div>` : ''}
                        ${state.staff ? `<div class="staff-display">${state.staff}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // コースボタンクリック
        function clickCourse(roomName, courseName) {
            let room = settings.rooms.find(r => r.name === roomName);
            if (!room) {
                room = settings.customRooms.find(r => r.name === roomName);
            }
            if (!room) return;

            const state = orderState[roomName].courses[courseName];
            
            // 最後の操作を保存
            lastAction = {
                room: roomName,
                course: courseName,
                previousState: JSON.parse(JSON.stringify(state))
            };

            // 状態遷移
            if (courseName === '果菜盛り' || courseName === 'しゃぶしゃぶ') {
                // 果菜盛り、しゃぶしゃぶ: 未 → 待 → 提 → 未
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                    showTimeModal(roomName, courseName);
                } else if (state.status === 'wait') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                }
            } else if (courseName === 'ステーキ' || courseName === '煮物') {
                // ステーキ、煮物: 未 → 待 → 肉 → 注 → 提 → 未
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                    showTimeModal(roomName, courseName);
                } else if (state.status === 'wait') {
                    state.status = 'meat';
                    showWCountModal(roomName, courseName);
                } else if (state.status === 'meat') {
                    state.status = 'order';
                } else if (state.status === 'order') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                    state.wCount = 0;
                }
            } else {
                // 通常: 未 → 待 → 注 → 提 → 未
                if (state.status === 'none') {
                    state.status = 'wait';
                    state.pressedTime = getCurrentTime();
                    showTimeModal(roomName, courseName);
                } else if (state.status === 'wait') {
                    state.status = 'order';
                } else if (state.status === 'order') {
                    state.status = 'serve';
                    showStaffModal(roomName, courseName);
                } else {
                    state.status = 'none';
                    state.time = null;
                    state.pressedTime = null;
                    state.staff = null;
                }
            }

            saveOrderState();
            renderOrderPage();
        }

        // 現在時刻取得
        function getCurrentTime() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        }

        // 時間選択モーダル
        function showTimeModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = '提供予定時刻を選択';
            
            const options = [3, 5, 10, 15, 20, 25];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(min => `
                        <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', ${min})">
                            +${min}分
                        </button>
                    `).join('')}
                    <button class="modal-btn" onclick="setTime('${roomName}', '${courseName}', 0)">
                        声がけ
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function setTime(roomName, courseName, minutes) {
            const state = orderState[roomName].courses[courseName];
            
            if (minutes > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + minutes);
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                state.time = `${h}:${m}`;
            } else {
                state.time = '声がけ';
            }

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // W数選択モーダル
        function showWCountModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            const room = settings.rooms.find(r => r.name === roomName);
            title.textContent = '焼き加減を選択';
            
            const options = ['なし', ...Array.from({length: room.people}, (_, i) => i + 1)];
            body.innerHTML = `
                <div class="modal-buttons">
                    ${options.map(opt => `
                        <button class="modal-btn" onclick="setWCount('${roomName}', '${courseName}', '${opt}')">
                            ${opt === 'なし' ? 'なし' : opt + '名'}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setWCount(roomName, courseName, count) {
            const state = orderState[roomName].courses[courseName];
            state.wCount = count === 'なし' ? 0 : parseInt(count);

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // スタッフ選択モーダル
        function showStaffModal(roomName, courseName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = '提供スタッフを選択';
            
            const enabledStaff = [
                ...settings.staff.filter(s => s.enabled),
                ...settings.customStaff.filter(s => s.enabled)
            ];
            
            body.innerHTML = `
                <div class="staff-select-grid">
                    ${enabledStaff.map(staff => `
                        <button class="modal-btn" onclick="setStaff('${roomName}', '${courseName}', '${staff.name}')">
                            ${staff.name}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setStaff(roomName, courseName, staffName) {
            const state = orderState[roomName].courses[courseName];
            state.staff = staffName;

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // モーダル閉じる
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Undo
        function undoLastAction() {
            if (!lastAction) {
                alert('元に戻す操作がありません');
                return;
            }

            orderState[lastAction.room].courses[lastAction.course] = lastAction.previousState;
            lastAction = null;

            saveOrderState();
            renderOrderPage();
        }

        // Order初期化
        function resetOrderState() {
            if (!confirm('Orderページをリセットしますか？')) return;
            
            initOrderState();
            saveOrderState();
            renderOrderPage();
            alert('リセットしました！');
        }

        // タブ切り替え
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            if (tab === 'index') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('index-page').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('order-page').classList.add('active');
                renderOrderPage();
            }
        }

        // 設定更新関数
        function toggleRoom(index) {
            settings.rooms[index].enabled = !settings.rooms[index].enabled;
            renderIndexPage();
        }

        function updateRoomPeople(index, value) {
            settings.rooms[index].people = parseInt(value);
        }

        function updateRoomTime(index, value) {
            settings.rooms[index].time = value;
        }

        function updateRoomPlan(index, value) {
            settings.rooms[index].plan = value;
            settings.rooms[index].allergies = {};
            renderIndexPage();
        }

        function updateRoomMemo(index, value) {
            settings.rooms[index].memo = value;
        }

        function updateRoomCake(index, checked) {
            settings.rooms[index].hasCake = checked;
        }

        function updateRoomPlate(index, checked) {
            settings.rooms[index].hasPlate = checked;
        }

        function updateAllergy(roomIndex, course, value) {
            settings.rooms[roomIndex].allergies[course] = value;
        }

        function toggleStaff(index) {
            settings.staff[index].enabled = !settings.staff[index].enabled;
        }

        // カスタマイズ部屋関連
        function addCustomRoom() {
            settings.customRooms.push({
                name: '',
                enabled: true,
                people: 2,
                time: '18:00',
                plan: 'スタンダード',
                memo: '',
                allergies: {},
                hasCake: false,
                hasPlate: false,
                isCustom: true
            });
            renderIndexPage();
        }

        function deleteCustomRoom(index) {
            if (confirm('このカスタマイズ部屋を削除しますか？')) {
                settings.customRooms.splice(index, 1);
                renderIndexPage();
            }
        }

        function toggleCustomRoom(index) {
            settings.customRooms[index].enabled = !settings.customRooms[index].enabled;
            renderIndexPage();
        }

        function updateCustomRoomName(index, value) {
            settings.customRooms[index].name = value;
        }

        function updateCustomRoomPeople(index, value) {
            settings.customRooms[index].people = parseInt(value);
        }

        function updateCustomRoomTime(index, value) {
            settings.customRooms[index].time = value;
        }

        function updateCustomRoomPlan(index, value) {
            settings.customRooms[index].plan = value;
            settings.customRooms[index].allergies = {};
            renderIndexPage();
        }

        function updateCustomRoomMemo(index, value) {
            settings.customRooms[index].memo = value;
        }

        function updateCustomRoomCake(index, checked) {
            settings.customRooms[index].hasCake = checked;
        }

        function updateCustomRoomPlate(index, checked) {
            settings.customRooms[index].hasPlate = checked;
        }

        // カスタマイズスタッフ関連
        function addCustomStaff() {
            const input = document.getElementById('custom-staff-input');
            const name = input.value.trim();
            
            if (!name) {
                alert('スタッフ名を入力してください');
                return;
            }
            
            settings.customStaff.push({
                name: name,
                enabled: true,
                isCustom: true
            });
            
            input.value = '';
            renderIndexPage();
        }

        function deleteCustomStaff(index) {
            if (confirm('このカスタマイズスタッフを削除しますか？')) {
                settings.customStaff.splice(index, 1);
                renderIndexPage();
            }
        }

        function toggleCustomStaff(index) {
            settings.customStaff[index].enabled = !settings.customStaff[index].enabled;
        }

        // アレルギー設定モーダル
        function showAllergyModal(roomIndex, isCustom) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            const room = isCustom ? settings.customRooms[roomIndex] : settings.rooms[roomIndex];
            const courses = PLANS[room.plan];
            
            title.textContent = `${room.name} - アレルギー設定`;
            
            body.innerHTML = `
                <div class="allergy-modal-content">
                    ${courses.map(course => `
                        <div class="allergy-input-group">
                            <label>${course}</label>
                            <input type="text" 
                                   id="allergy-${course}" 
                                   value="${room.allergies[course] || ''}" 
                                   placeholder="例: えび・かに">
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-primary" onclick="saveAllergies(${roomIndex}, ${isCustom})">
                    保存
                </button>
            `;
            
            modal.classList.add('active');
        }

        function saveAllergies(roomIndex, isCustom) {
            const room = isCustom ? settings.customRooms[roomIndex] : settings.rooms[roomIndex];
            const courses = PLANS[room.plan];
            
            courses.forEach(course => {
                const input = document.getElementById(`allergy-${course}`);
                if (input) {
                    room.allergies[course] = input.value.trim();
                }
            });
            
            closeModal();
            alert('アレルギー設定を保存しました');
        }

        // 食べるスピード選択モーダル
        function showEatingSpeedModal(roomName) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = '食べるスピードを選択';
            
            body.innerHTML = `
                <div class="modal-buttons">
                    ${EATING_SPEEDS.map(speed => `
                        <button class="modal-btn" onclick="setEatingSpeed('${roomName}', '${speed}')">
                            ${speed}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.classList.add('active');
        }

        function setEatingSpeed(roomName, speed) {
            if (!orderState[roomName]) {
                orderState[roomName] = { eatingSpeed: 'N', courses: {} };
            }
            orderState[roomName].eatingSpeed = speed;

            closeModal();
            saveOrderState();
            renderOrderPage();
        }

        // 初期化実行
        init();
    </script>
</body>
</html>